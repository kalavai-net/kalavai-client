services:
{% if vpn %}
  {{vpn_name}}:
    image: gravitl/netclient:v0.90.0
    container_name: {{vpn_name}}
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: host
    environment:
      - HOST_NAME={{node_name}}
      - TOKEN={{vpn_token}}
    volumes:
      - /dev/net/tun:/dev/net/tun
    restart: unless-stopped
{% endif %}
{% if backend %}
  backend:
    image: docker.io/bundenth/kalavai-backend:latest
    container_name: backend
    networks:
    - kalavai-net
    ports:
    - "{{bridge_port | default(8001)}}:{{bridge_port | default(8001)}}"
    command: >
      backend
      start
      --bridge-port {{bridge_port | default(8001)}}
    environment:
      - KALAVAI_PATH=/root/.cache/kalavai
    volumes:
      - "{{user_path}}:/root/.cache/kalavai"
    restart: unless-stopped
{% endif %}
{% if frontend %}
  frontend:
    container_name: frontend
    image: bundenth/kalavai-gui:latest
    networks:
    - kalavai-net
    environment:
    - KALAVAI_BRIDGE_URL=http://backend
    - KALAVAI_BRIDGE_PORT={{bridge_port | default(8001)}}
    {% if protected_access %}
    - ACCESS_KEY={{protected_access}}
    {% endif %}
    entrypoint: ["reflex"]
    command: >
      run
      --backend-port {{gui_backend_port | default(8002)}}
      --frontend-port {{gui_frontend_port | default(3000)}}
    ports:
    - "{{gui_backend_port | default(8002)}}:{{gui_backend_port | default(8002)}}"
    - "{{gui_frontend_port | default(3000)}}:{{gui_frontend_port | default(3000)}}"
    volumes:
      - "{{user_path}}:/root/.cache/kalavai"
    restart: unless-stopped
{% endif %}

# run worker only if command is set
{%if command %}
  {{service_name}}:
    image: docker.io/bundenth/kalavai-runner:gpu-latest
    container_name: {{service_name}}
  {% if vpn %}
    depends_on:
    - {{vpn_name}}
    network_mode: "service:{{vpn_name}}"
  {% else %}
    network_mode: host
  {% endif %}
    privileged: true
    restart: unless-stopped
    command: >
      --command={{command}}
      --node_name="{{node_name}}"
      --node_ip="{{node_ip_address}}"
      {% if command == "server" %}
      --port_range="30000-32767"
      {% else %}
      --server_ip={{pool_ip}}
      --token={{pool_token}}
      {% endif %}
      {%if vpn %}
      --flannel_iface={{flannel_iface}}
      {% endif %}
      {% if num_gpus and num_gpus > 0 %}
      --gpu=on
      {% else %}
      --gpu=off
      {% endif %}
      {% if node_labels %}
      --extra="{{node_labels}}"
      {% endif %}

    # volumes:
    # - {{k3s_path}}:/var/lib/rancher/k3s # Persist data
    # - {{etc_path}}:/etc/rancher/k3s # Config files

  {% if num_gpus and num_gpus > 0 %}
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            count: {{num_gpus}}
            capabilities: [gpu]
  {% endif %}
{% endif %}

networks:
  kalavai-net:
    driver: bridge