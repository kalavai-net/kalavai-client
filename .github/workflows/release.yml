---
name: Publish Python ðŸ distribution ðŸ“¦ to PyPI and TestPyPI

on: # yamllint disable-line rule:truthy
  release:
    types: [created]

jobs:
  build:
    name: Build distribution ðŸ“¦
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    - name: Install pypa/build
      run: >-
        pip3 install .[dev]
    - name: Build a binary wheel and a source tarball
      run: python3 -m build
    # --- New Step to get Package Version ---
    # We need the version from the code to tag the Docker image.
    - name: Get package version
      id: get_version
      run: |
        # This assumes your version is in your pyproject.toml
        PACKAGE_VERSION=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
        echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
      shell: bash
    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
---

  build-and-push-docker:
    name: Build and Push Docker Image ðŸ³ to Docker Hub
    # Depends on 'build' to get the package version
    needs: [build] 
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: read 
    
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          
      # 1. Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }} # Needs to be defined in repo secrets
          password: ${{ secrets.DOCKER_HUB_TOKEN }} # Needs to be defined in repo secrets (PAT recommended)
          
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      # 2. Prepare secrets to pass to the Docker build
      - name: Prepare Docker build secrets
        id: secrets
        run: |
          # Define your secrets here (e.g., from your GitHub Repo Secrets)
          DOCKER_SECRETS="MY_API_KEY=${{ secrets.MY_REPO_API_KEY }},MY_TOKEN=${{ secrets.ANOTHER_REPO_SECRET }}"
          echo "DOCKER_SECRETS=$DOCKER_SECRETS" >> $GITHUB_OUTPUT
        shell: bash

      # 3. Extract metadata (tags, labels) for Docker
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Format: <DOCKER_HUB_USERNAME>/<IMAGE_NAME>
          images: ${{ secrets.DOCKER_USERNAME }}/kalavai-client 
          tags: |
            # Tag with the version extracted from the 'build' job
            type=raw,value=${{ needs.build.outputs.PACKAGE_VERSION }}
            # Also tag with 'latest'
            type=raw,value=latest
            
      # 4. Build and push the Docker image
      - name: Build and push Docker image
        uses: docker/build-and-push-action@v5
        with:
          context: . # Assumes your Dockerfile is in the root directory
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          secrets: |
            ${{ steps.secrets.outputs.DOCKER_SECRETS }}
---

#   publish-to-pypi:
#     name: >-
#       Publish Python ðŸ distribution ðŸ“¦ to PyPI
#     if: startsWith(github.ref, 'refs/tags/')  # only publish to PyPI on tag pushes
#     needs:
#     - build
#     runs-on: ubuntu-24.04
#     environment:
#       name: pypi
#       url: https://pypi.org/p/kalavai-client
#     permissions:
#       id-token: write  # IMPORTANT: mandatory for trusted publishing

#     steps:
#     - name: Download all the dists
#       uses: actions/download-artifact@v4
#       with:
#         name: python-package-distributions
#         path: dist/
#     - name: Publish distribution ðŸ“¦ to PyPI
#       uses: pypa/gh-action-pypi-publish@release/v1

# ---

#   publish-to-testpypi:
#     name: Publish Python ðŸ distribution ðŸ“¦ to TestPyPI
#     needs:
#     - build
#     runs-on: ubuntu-24.04

#     environment:
#       name: testpypi
#       url: https://test.pypi.org/p/kalavai-client

#     permissions:
#       id-token: write  # IMPORTANT: mandatory for trusted publishing

#     steps:
#     - name: Download all the dists
#       uses: actions/download-artifact@v4
#       with:
#         name: python-package-distributions
#         path: dist/
#     - name: Publish distribution ðŸ“¦ to TestPyPI
#       uses: pypa/gh-action-pypi-publish@release/v1
#       with:
#         repository-url: https://test.pypi.org/legacy/

#   build-and-push-dockerhub:
#     runs-on: ubuntu-24.04
#     if: startsWith(github.ref, 'refs/tags/')  # only publish to PyPI on tag pushes
#     needs:
#     - publish-to-pypi

#     # No 'packages: write' needed, but 'contents: read' is still required for checkout
#     permissions:
#       contents: read 

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Extract Python Package Version
#         id: get_version
#         # 1. Install the required TOML parser (must be first)
#         run: pip install toml

#       - name: Extract Python Package Version
#         run: |
#           VERSION=$(python -c "
# import toml
# data = toml.load('pyproject.toml')
# # Assuming version is defined under [tool.poetry]
# version = data['tool']['poetry']['version']
# print(version)
# " 2>/dev/null)
          
#           if [ -z "$VERSION" ]; then
#             echo "::error::Could not find 'version' in pyproject.toml. Check the path used in the Python script."
#             exit 1
#           fi

#           echo "PYTHON_VERSION=$VERSION" >> $GITHUB_ENV
#           echo "::notice file=pyproject.toml::Extracted version: $VERSION"

#       - name: Set up QEMU
#         uses: docker/setup-qemu-action@v3

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Log in to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           registry: docker.io 
#           username: ${{ secrets.DOCKER_HUB_USERNAME }} 
#           password: ${{ secrets.DOCKER_HUB_TOKEN }} 

#       - name: Extract metadata (tags, labels) for Docker
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: kalavai/${{ github.event.repository.name }}
#           tags: |
#             # Tag 1: The Pypi version (e.g., 0.8.0)
#             type=raw,value=${{ env.PYTHON_VERSION }}
#             # Tag 2: 'latest' (only on the default branch)
#             type=raw,value=latest,enable={{is_default_branch}}

#       - name: Build and push Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: .
#           push: true
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max